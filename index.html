<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jewel Bank Monitor</title>

  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">

  <style>
    :root{
      --bg:#0b1220;
      --card:#111a2e;
      --text:#e6edf7;
      --muted:#93a4bf;
      --border:#21304f;
      --accent:#4f8cff;
      --danger:#ff5c7a;
      --warn:#ffb84d;
      --ok:#4dd28a;
    }
    body{
      font-family: Arial, sans-serif;
      margin: 18px;
      background: var(--bg);
      color: var(--text);
    }

    .topbar{
      display:flex;
      gap:12px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:14px;
    }

    h1{ margin:0; font-size:22px; }
    .meta{ color:var(--muted); font-size:12px; margin-top:6px; }

    .controls{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    select, input[type="number"], input[type="text"]{
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      outline: none;
    }

    .btn{
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight:600;
    }

    .btn.secondary{
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(4, minmax(160px, 1fr));
      gap:12px;
      margin: 10px 0 14px 0;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
    }

    .card .label{ color: var(--muted); font-size: 12px; }
    .card .value{ font-size: 18px; font-weight: 700; margin-top: 6px; }

    /* Summary */
    #summary { margin: 12px 0 16px; }
    .grid2 { display:grid; grid-template-columns: repeat(2, minmax(240px, 1fr)); gap:12px; }
    .panel { background: var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; }
    .panel h3 { margin:0 0 10px; font-size:14px; color:var(--muted); font-weight:700; display:flex; justify-content:space-between; align-items:center; gap:10px;}
    .panel h3 .hint { font-size:12px; font-weight:600; color: var(--muted); }
    .row { display:flex; justify-content:space-between; gap:10px; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.06); align-items:flex-start; }
    .row:last-child { border-bottom:none; }
    .name { font-weight:700; max-width: 65%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .meta2 { color:var(--muted); font-size:12px; text-align:right; white-space:nowrap; }
    .warn {
      background: rgba(255, 184, 77, 0.12);
      border:1px solid rgba(255, 184, 77, 0.35);
      padding:10px 12px;
      border-radius:12px;
      margin-bottom:10px;
      color: #ffd08a;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pillbar { display:flex; gap:8px; flex-wrap:wrap; }
    .pill{
      border:1px solid var(--border);
      background: rgba(255,255,255,0.04);
      border-radius: 999px;
      padding: 6px 10px;
      font-size:12px;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .pill:hover{ border-color: rgba(79,140,255,0.6); color: var(--text); }
    .pill.active{ border-color: var(--accent); color: var(--text); background: rgba(79,140,255,0.12); }

    /* DataTables theme tweaks */
    table.dataTable{
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 14px;
    }
    .dataTables_wrapper .dataTables_filter input{
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 10px;
      outline: none;
    }
    .dataTables_wrapper .dataTables_length select{
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 10px;
      outline: none;
    }

    @media (max-width: 920px){
      .cards{ grid-template-columns: repeat(2, minmax(160px, 1fr)); }
      .grid2{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>

  <div class="topbar">
    <div>
      <h1>ðŸ’Ž Jewel Bank Monitor</h1>
      <div class="meta" id="meta">Loading...</div>
    </div>

    <div class="controls">
      <label class="meta" for="minCount">Min ItemCount</label>
      <input id="minCount" type="number" value="0" min="0" style="width:120px" />
      <button class="btn" id="btnRefresh">Refresh</button>
      <button class="btn secondary" id="btnReset">Reset Filters</button>
    </div>
  </div>

  <div class="cards">
    <div class="card">
      <div class="label">Rows</div>
      <div class="value" id="statRows">â€”</div>
    </div>
    <div class="card">
      <div class="label">Total ItemCount</div>
      <div class="value" id="statTotal">â€”</div>
    </div>
    <div class="card">
      <div class="label">Unique Accounts</div>
      <div class="value" id="statAccounts">â€”</div>
    </div>
    <div class="card">
      <div class="label">Last Updated</div>
      <div class="value" id="statUpdated">â€”</div>
    </div>
  </div>

  <!-- Summary -->
  <div id="summary"></div>

  <table id="tbl" class="display" style="width:100%">
    <thead>
      <tr>
        <th>AccountID</th>
        <th>ItemName</th>
        <th>ItemCount</th>
      </tr>
    </thead>
  </table>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>

  <script>
    const DATA_URL = "https://raw.githubusercontent.com/huey-afk/mu-item-data/refs/heads/main/data.json";

    let dt = null;
    let lastRows = [];               // raw rows
    let activePill = null;           // active quick filter (item/account)
    let minCountValue = 0;           // min ItemCount filter

    function fmt(n){
      return new Intl.NumberFormat().format(n || 0);
    }

    function safeStr(v){
      if (v === null || v === undefined) return "â€”";
      const s = String(v);
      return s.length ? s : "â€”";
    }

    function toNum(v){
      const n = Number(v);
      return Number.isFinite(n) ? n : 0;
    }

    function clearActivePill(){
      activePill = null;
      document.querySelectorAll(".pill").forEach(p => p.classList.remove("active"));
    }

    function applyTableFilters(){
      if (!dt) return;

      // min count filter: we use a DataTables custom search hook
      dt.draw();

      // item/account pill filter: use column search
      if (activePill?.type === "item") {
        dt.column(1).search("^" + escapeRegExp(activePill.value) + "$", true, false);
        dt.column(0).search(""); // clear account search
      } else if (activePill?.type === "account") {
        dt.column(0).search("^" + escapeRegExp(activePill.value) + "$", true, false);
        dt.column(1).search(""); // clear item search
      } else {
        dt.column(0).search("");
        dt.column(1).search("");
      }

      dt.draw();
    }

    function escapeRegExp(string) {
      return String(string).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // DataTables custom filter for min ItemCount
    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex){
      // data[2] is ItemCount column
      const count = Number(data[2]) || 0;
      return count >= (minCountValue || 0);
    });

    function buildSummary(rows, generatedAt){
      // totals
      const totalCount = rows.reduce((s,r)=> s + toNum(r.ItemCount), 0);

      // by item
      const itemTotals = new Map();
      const itemAccounts = new Map(); // item -> Set(accounts)
      const itemMaxOneAccount = new Map(); // item -> max count held by a single account

      // by account
      const accountTotals = new Map();
      const accountUniqueItems = new Map(); // acc -> Set(items)

      // data health
      let invalidFieldCount = 0;
      let nonPositiveCount = 0;

      for (const r of rows) {
        const acc = safeStr(r.AccountID);
        const item = safeStr(r.ItemName);
        const c = toNum(r.ItemCount);

        if (acc === "â€”" || item === "â€”" || !Number.isFinite(Number(r.ItemCount))) invalidFieldCount++;
        if (c <= 0) nonPositiveCount++;

        itemTotals.set(item, (itemTotals.get(item) || 0) + c);
        if (!itemAccounts.has(item)) itemAccounts.set(item, new Set());
        itemAccounts.get(item).add(acc);
        itemMaxOneAccount.set(item, Math.max(itemMaxOneAccount.get(item) || 0, c));

        accountTotals.set(acc, (accountTotals.get(acc) || 0) + c);
        if (!accountUniqueItems.has(acc)) accountUniqueItems.set(acc, new Set());
        accountUniqueItems.get(acc).add(item);
      }

      const topItems = [...itemTotals.entries()]
        .sort((a,b)=> b[1]-a[1])
        .slice(0, 10)
        .map(([item, count]) => ({
          item,
          count,
          holders: itemAccounts.get(item)?.size || 0,
          maxOne: itemMaxOneAccount.get(item) || 0,
          pct: totalCount ? (count/totalCount)*100 : 0
        }));

      const topAccounts = [...accountTotals.entries()]
        .sort((a,b)=> b[1]-a[1])
        .slice(0, 10)
        .map(([acc, count]) => ({
          acc,
          count,
          uniqueItems: accountUniqueItems.get(acc)?.size || 0
        }));

      // concentration: items where maxOneAccount / totalItem is high (top 10)
      const concentrated = topItems
        .map(x => ({
          ...x,
          concentration: x.count ? (x.maxOne / x.count) * 100 : 0
        }))
        .sort((a,b)=> b.concentration - a.concentration)
        .slice(0, 10);

      // quick filter pills (top 5 items + top 5 accounts)
      const pillHTML = `
        <div class="pillbar">
          ${topItems.slice(0,5).map(x => `<div class="pill" data-type="item" data-value="${escapeHtml(x.item)}">Item: ${escapeHtml(x.item)}</div>`).join("")}
          ${topAccounts.slice(0,5).map(x => `<div class="pill" data-type="account" data-value="${escapeHtml(x.acc)}">Acct: ${escapeHtml(x.acc)}</div>`).join("")}
        </div>
      `;

      const healthBanner = (invalidFieldCount || nonPositiveCount) ? `
        <div class="warn">
          <div>
            <strong>Data health</strong>
            <div class="meta" style="margin-top:6px">
              ${invalidFieldCount ? `â€¢ ${fmt(invalidFieldCount)} rows have missing/invalid fields<br>` : ""}
              ${nonPositiveCount ? `â€¢ ${fmt(nonPositiveCount)} rows have ItemCount â‰¤ 0` : ""}
            </div>
          </div>
          <div class="meta">Tip: click a pill to filter the table</div>
        </div>
      ` : `
        <div class="warn" style="border-color: rgba(77,210,138,0.35); background: rgba(77,210,138,0.10); color: #bff4d6;">
          <div>
            <strong>Data health</strong>
            <div class="meta" style="margin-top:6px">Looks good: no obvious missing fields, and ItemCount values are mostly positive.</div>
          </div>
          <div class="meta">Tip: click a pill to filter the table</div>
        </div>
      `;

      const html = `
        ${healthBanner}
        ${pillHTML}
        <div class="grid2" style="margin-top:12px;">
          <div class="panel">
            <h3>
              <span>Top Items</span>
              <span class="hint">total â€¢ holders â€¢ % overall</span>
            </h3>
            ${topItems.map(x => `
              <div class="row">
                <div class="name" title="${escapeHtml(x.item)}">${escapeHtml(x.item)}</div>
                <div class="meta2">${fmt(x.count)} â€¢ ${fmt(x.holders)} â€¢ ${x.pct.toFixed(1)}%</div>
              </div>
            `).join("")}
          </div>

          <div class="panel">
            <h3>
              <span>Top Accounts</span>
              <span class="hint">total â€¢ unique items</span>
            </h3>
            ${topAccounts.map(x => `
              <div class="row">
                <div class="name" title="${escapeHtml(x.acc)}">${escapeHtml(x.acc)}</div>
                <div class="meta2">${fmt(x.count)} â€¢ ${fmt(x.uniqueItems)}</div>
              </div>
            `).join("")}
          </div>

          <div class="panel" style="grid-column: 1 / -1;">
            <h3>
              <span>Most Concentrated Items</span>
              <span class="hint">max in one acct / item total</span>
            </h3>
            ${concentrated.map(x => `
              <div class="row">
                <div class="name" title="${escapeHtml(x.item)}">${escapeHtml(x.item)}</div>
                <div class="meta2">${x.concentration.toFixed(1)}% â€¢ max ${fmt(x.maxOne)} / total ${fmt(x.count)}</div>
              </div>
            `).join("")}
          </div>
        </div>
      `;

      const summaryEl = document.getElementById("summary");
      summaryEl.innerHTML = html;

      // Wire pill click handlers
      summaryEl.querySelectorAll(".pill").forEach(p => {
        p.addEventListener("click", () => {
          const type = p.getAttribute("data-type");
          const value = p.getAttribute("data-value");

          // toggle behavior
          const already = activePill && activePill.type === type && activePill.value === value;
          clearActivePill();

          if (!already) {
            activePill = { type, value };
            p.classList.add("active");
          }
          applyTableFilters();
        });
      });
    }

    function escapeHtml(str){
      return String(str)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function loadData() {
      try {
        document.getElementById("meta").textContent = "Loading...";

        const url = DATA_URL + "?v=" + Date.now(); // force refresh
        const res = await fetch(url, { cache: "no-store" });

        if (!res.ok) {
          document.getElementById("meta").textContent =
            "âŒ Failed to load data.json (" + res.status + ")";
          return;
        }

        const payload = await res.json();
        const rows = payload.rows || [];
        lastRows = rows;

        const generatedAt = payload.generated_at || "â€”";
        document.getElementById("meta").textContent = "Updated: " + generatedAt;

        document.getElementById("statRows").textContent = fmt(rows.length);

        const total = rows.reduce((s,r)=> s + toNum(r.ItemCount), 0);
        document.getElementById("statTotal").textContent = fmt(total);

        const accounts = new Set(rows.map(r=> safeStr(r.AccountID))).size;
        document.getElementById("statAccounts").textContent = fmt(accounts);

        document.getElementById("statUpdated").textContent = generatedAt;

        // summary block
        buildSummary(rows, generatedAt);

        const tableData = rows.map(r => [
          safeStr(r.AccountID),
          safeStr(r.ItemName),
          toNum(r.ItemCount)
        ]);

        if (!dt) {
          dt = $('#tbl').DataTable({
            data: tableData,
            order: [[2, "desc"]],
            pageLength: 50,
            deferRender: true
          });
        } else {
          dt.clear().rows.add(tableData).draw();
        }

        // Re-apply current filters after refresh
        applyTableFilters();

      } catch (err) {
        document.getElementById("meta").textContent =
          "âŒ JSON error or network issue";
        console.error(err);
      }
    }

    // Controls
    document.getElementById("btnRefresh").addEventListener("click", () => {
      loadData();
    });

    document.getElementById("btnReset").addEventListener("click", () => {
      document.getElementById("minCount").value = 0;
      minCountValue = 0;
      clearActivePill();
      if (dt) {
        dt.search("").columns().search("");
      }
      applyTableFilters();
    });

    document.getElementById("minCount").addEventListener("input", (e) => {
      minCountValue = Number(e.target.value || 0);
      applyTableFilters();
    });

    // initial load
    loadData();
  </script>

</body>
</html>
