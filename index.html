<script>
  // ✅ CHANGE THIS to your real data.json URL
  // Option A (GitHub RAW):
  // const DATA_URL = "https://raw.githubusercontent.com/USER/REPO/main/data.json";
  //
  // Option B (GitHub Pages):
  // const DATA_URL = "https://USER.github.io/REPO/data.json";

  const DATA_URL = "https://raw.githubusercontent.com/huey-afk/mu-item-data/refs/heads/main/data.json";

  let dt = null;
  let autoTimer = null;
  let autoOn = false;
  let lastPayloadRows = [];

  function fmt(n){
    try { return new Intl.NumberFormat().format(n); }
    catch(e){ return String(n); }
  }

  function computeStats(rows, generatedAt){
    const total = rows.reduce((s,r)=> s + (Number(r.ItemCount)||0), 0);
    const accounts = new Set(rows.map(r=> String(r.AccountID || "").trim()).filter(Boolean)).size;

    document.getElementById('statRows').textContent = fmt(rows.length);
    document.getElementById('statTotal').textContent = fmt(total);
    document.getElementById('statAccounts').textContent = fmt(accounts);
    document.getElementById('statUpdated').textContent = generatedAt || "—";
  }

  function rebuildItemFilter(rows){
    const sel = document.getElementById('itemFilter');
    const current = sel.value;

    const names = Array.from(new Set(rows.map(r => r.ItemName).filter(Boolean)))
      .sort((a,b)=> String(a).localeCompare(String(b)));

    sel.innerHTML =
      '<option value="">All</option>' +
      names.map(n => `<option value="${String(n).replaceAll('"','&quot;')}">${n}</option>`).join('');

    if (names.includes(current)) sel.value = current;
  }

  async function loadData() {
    try {
      if (!DATA_URL || DATA_URL.includes("PASTE_YOUR_DATA_JSON_URL_HERE")) {
        document.getElementById('meta').textContent =
          "❌ Please set DATA_URL to your data.json (Raw GitHub or GitHub Pages link).";
        return;
      }

      // ✅ cache-buster to force latest file
      const res = await fetch(DATA_URL + "?v=" + Date.now(), { cache: "no-store" });

      if (!res.ok) {
        document.getElementById('meta').textContent =
          `❌ Failed to load data.json (${res.status}). Check DATA_URL.`;
        return;
      }

      const payload = await res.json();
      const rows = payload.rows || [];
      lastPayloadRows = rows;

      document.getElementById('meta').textContent =
        `Updated: ${payload.generated_at || "—"} | Rows: ${rows.length} | Unknown mappings: ${payload.unknown_mappings ?? "—"}`;

      computeStats(rows, payload.generated_at);
      rebuildItemFilter(rows);

      const tableData = rows.map(r => [
        r.AccountID ?? "",
        r.ItemName ?? "",
        Number(r.ItemCount ?? 0)
      ]);

      if (!dt) {
        dt = $('#tbl').DataTable({
          data: tableData,
          columns: [
            { title: "AccountID" },
            { title: "ItemName" },
            { title: "ItemCount" }
          ],
          order: [[2, 'desc']],
          pageLength: 50
        });
      } else {
        dt.clear();
        dt.rows.add(tableData);
        dt.draw();
      }

      applyItemFilter();
    } catch (err) {
      document.getElementById('meta').textContent =
        "❌ Error loading JSON. Open DevTools Console to see details.";
      console.error(err);
    }
  }

  function applyItemFilter(){
    if (!dt) return;
    const val = document.getElementById('itemFilter').value;
    dt.column(1).search(val ? '^' + escapeRegex(val) + '$' : '', true, false).draw();
  }

  function escapeRegex(text){
    return String(text).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  }

  function setAuto(on){
    autoOn = on;
    const btn = document.getElementById('toggleAuto');
    btn.textContent = on ? 'Auto: ON' : 'Auto: OFF';
    btn.classList.toggle('secondary', !on);

    if (autoTimer) clearInterval(autoTimer);
    autoTimer = null;

    if (on) {
      const sec = Math.max(10, Number(document.getElementById('refreshSec').value || 60));
      autoTimer = setInterval(loadData, sec * 1000);
    }
  }

  document.getElementById('refreshNow').addEventListener('click', loadData);
  document.getElementById('itemFilter').addEventListener('change', applyItemFilter);

  document.getElementById('toggleAuto').addEventListener('click', () => {
    setAuto(!autoOn);
  });

  document.getElementById('refreshSec').addEventListener('change', () => {
    if (autoOn) setAuto(true);
  });

  loadData();
</script>
